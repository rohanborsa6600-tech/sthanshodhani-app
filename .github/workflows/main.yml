name: Build Sthanshodhani APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. рддреБрдордЪрд╛ рдХреЛрдб рдШреЗрдгреЗ
      - uses: actions/checkout@v3

      # 2. Node.js рд╕реЗрдЯ рдХрд░рдгреЗ
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      
      # 3. Cordova рдЯреВрд▓ рдЯрд╛рдХрдгреЗ
      - run: npm install -g cordova

      # 4. Java 17 рдЯрд╛рдХрдгреЗ (Android 12+ рд╕рд╛рдареА рдЧрд░рдЬреЗрдЪреЗ)
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 5. рдирд╡реАрди рдлреНрд░реЗрд╢ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдирд╡рдгреЗ
      - name: Create Fresh Cordova Project
        run: |
          # рдирд╡реАрди рдХреЛрд░рд╛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рддрдпрд╛рд░ рдХрд░рд╛
          cordova create SthanshodhaniApp com.sthanshodhani.app "Sthanshodhani"
          
          # рдкреНрд░реЛрдЬреЗрдХреНрдЯрдЪреНрдпрд╛ рдЖрдд рдЬрд╛
          cd SthanshodhaniApp
          
          # рдкреНрд▓рдЧрдЗрдиреНрд╕ ре▓рдб рдХрд░рд╛
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-statusbar
          cordova plugin add cordova-plugin-whitelist
          
          # Android рдкреНрд▓реЕрдЯрдлреЙрд░реНрдо ре▓рдб рдХрд░рд╛
          cordova platform add android@12.0.0
          
          cd ..

      # 6. рд╕реЗрдЯрд┐рдВрдЧреНрдЬ рд▓рд╛рд╡рдгреЗ (Logo & Full Screen)
      - name: Configure Settings & Icon
        run: |
          cd SthanshodhaniApp
          
          # ЁЯФе ре▓рдк рдЖрдпрдХреЙрди рд╕реЗрдЯ рдХрд░рдгреЗ (рд╣реЗ рдорд╣рддреНрддреНрд╡рд╛рдЪреЗ рдЖрд╣реЗ)
          sed -i '/<widget/a <icon src="www/logo.png" />' config.xml
          
          # рдлреБрд▓ рд╕реНрдХреНрд░реАрди рдореЛрдб
          sed -i '/<widget/a <preference name="Fullscreen" value="true" />' config.xml
          
          # рдУрд╡реНрд╣рд░рд╕реНрдХреНрд░реЛрд▓ рдмрдВрдж
          sed -i '/<widget/a <preference name="DisallowOverscroll" value="true" />' config.xml
          
          # Android 12 Splash Screen Fix
          sed -i '/<widget/a <preference name="AndroidWindowSplashScreenAnimatedIcon" value="www/logo.png" />' config.xml
          sed -i '/<widget/a <preference name="AndroidWindowSplashScreenBackground" value="#000000" />' config.xml
          
          cd ..

      # 7. рддреБрдордЪреНрдпрд╛ рдлрд╛рдИрд▓реНрд╕ рдирд╡реАрди ре▓рдкрдордзреНрдпреЗ рдЯрд╛рдХрдгреЗ
      - name: Copy User Files
        run: |
          # рдирд╡реАрди рдкреНрд░реЛрдЬреЗрдХреНрдЯрдордзреАрд▓ рдбреАрдлреЙрд▓реНрдЯ рдлрд╛рдИрд▓реНрд╕ рдЙрдбрд╡рдгреЗ
          rm SthanshodhaniApp/www/index.html
          rm -rf SthanshodhaniApp/www/js
          rm -rf SthanshodhaniApp/www/css
          rm -rf SthanshodhaniApp/www/img

          # рддреБрдордЪреА www рдлреЛрд▓реНрдбрд░рдЪреА рд╕рд░реНрд╡ рд╕рд╛рдордЧреНрд░реА (Logo рд╕рд╣) рдХреЙрдкреА рдХрд░рдгреЗ
          cp -r www/* SthanshodhaniApp/www/

      # 8. APK рдлрд╛рдпрдирд▓ рдмрд┐рд▓реНрдб рдХрд░рдгреЗ
      - name: Build APK
        run: |
          cd SthanshodhaniApp
          cordova build android --debug

      # 9. APK рдЕрдкрд▓реЛрдб рдХрд░рдгреЗ
      - uses: actions/upload-artifact@v4
        with:
          name: Sthanshodhani-APK
          path: SthanshodhaniApp/platforms/android/app/build/outputs/apk/debug/app-debug.apk
